{% extends "rome_templates/base.html" %}

{% block title%}The Theater that was Rome - Search{% endblock %}

{% block javascript %}
 <script type="text/javascript">

 //TO_DO - make sure no "memory leaks" - (clearing everything property) 
 //TO_DO - take out unneccessary stuff now that real-time loading, just create displaypage() function - still a bunch to delete
 //TO_DO - think about searching other fields besides the annotations
 //TO_DO - error with aldini?

 var book_to_page = [];
 var book_to_title = [];
 var prints = [];
 var page_display_counter = 0;
 var page_length;
 var results;
 var appended_books = [];

 $(document).ready(function() {
 	$("#searchbutton").on('click', submit_search);
 });
 function inputKeyUp(e) {
    e.which = e.which || e.keyCode;
    if(e.which == 13) {
        submit_search();
    }
 }
 function submit_search(){
 	var searchterm = $("#search")[0].value;
 	//TO-DO - this max row limit means sometimes we don't get ALL the results...
 	$.getScript("{{querystart}}+"+ searchterm +"&callback=result_response&rows=500"); 
 }
 function result_response(data){
 	clear_results();
 	var num = data.response.numFound;
 	if (num > 500){
 		$("#num_results").text("Showing first 500 results out of "+ num);
 	} else{
 		$("#num_results").text(num);
 	}
 	results = data.response.docs;
 	var show = true;
 	var pagepids = [];
 	var resdivs = [];
 	for (var i =0;  i < results.length; i++){
 		pagepids.push(results[i].rel_is_annotation_of_ssim[0]);
 	}
 	group_by_book(pagepids);
 }

 /**
 function display_loaded_pages(){
 	for (var key in book_to_page){
 		if (book_to_page.hasOwnProperty(key) && appended_books[key]!=1) {
 			create_book_div(key);
 		}
 	}
 	create_thumbnails();
 }

 function create_thumbnails(){
 	var resdiv;
 	for (var key in book_to_page){
 		for (var x=0; x<book_to_page[key].length;x++){
 			if (book_to_page[key][x] != null){
 				resdiv = display_result(book_to_page[key][x], key, true);
 				$("#bookdiv"+key.substring(4)).append(resdiv);
 				var num_div = $("#booknumber"+key.substring(4));
 				var curr_num = parseInt(num_div.text());
 				num_div.text(curr_num+1);
 			}
 			book_to_page[key][x] = null;
 		}
 	}
 }
**/

 function display_page(bookpid, pagepid){
 	console.log("book: "+bookpid);
 	console.log("page: "+pagepid);
  	if (book_to_page.hasOwnProperty(bookpid) && appended_books[bookpid]!=1) {
 		create_book_div(bookpid);
 	}
 	add_thumbnail(bookpid,pagepid);
 }

 function display_print(printpid){
 	console.log("print: " + printpid);
 	//TO_DO printdiv = create_thumbnail(printpid);
 }

 function add_thumbnail(bookpid,pagepid){
 	resdiv = create_thumbnail(pagepid, bookpid, true);
 	$("#bookdiv"+bookpid.substring(4)).append(resdiv);
 	var num_div = $("#booknumber"+bookpid.substring(4));
 	var curr_num = parseInt(num_div.text());
 	num_div.text(curr_num+1);
 }

 function create_book_div(bookpid){
 	var book_div = $(document.createElement('div'));
 	book_div.css({
 		"height": "250px",
 		"overflow-y": "scroll",
 		"margin-bottom": "20px"
 	});
 	book_div.attr("id", "bookdiv"+bookpid.substring(4));
 	var book_title = $(document.createElement('div'));
 	var book_number = $(document.createElement('div'));
 	book_title.css({
 		"height": "30px",
 		"width" : "200px",
 		"float" : "left"
 	});
 	//TO-DO get title not to overflow
 	book_title.text(book_to_title[bookpid] + " number results:");
 	book_number.text(0);
 	book_number.css({
 		"width": "20px",
 		"height": "30px",
 		"margin-left": "200px"
 	}).attr('id', "booknumber"+bookpid.substring(4));
 	//book_div.append(book_title);
 	book_div.append(book_number);
 	$("#books").append(book_div);
 	appended_books[bookpid] = 1;
 }

 function create_thumbnail(pagepid, bookpid, thumb){
 	var result_div = $(document.createElement('div')).css({
 		"width": "250px",
 		"float": "left",
 	});
 	var page_link = $(document.createElement('a'));
 	page_link.attr('href', '/rome/books/'+bookpid.substring(4)+'/'+pagepid.substring(4));
 	page_link.attr('target', '_blank');
 	result_div.append(page_link);
 	var pages = [];
 	if (thumb){
 		var thumbnail = $(document.createElement('img'));
 		thumbnail.attr('height', '150px');
 		thumbnail.attr('src', "{{pagequery}}"+pagepid+"/");
 		page_link.append(thumbnail);
 		var info = $(document.createElement('div'));
 		info.attr('height','150px');
 		info.text("page pid:" + pagepid.substring(4));
 		page_link.append(info);
 	} else {
 		page_link.text(pagepid.substring(4));
 	}
 	return result_div;
 }

 function clear_results(){
 	book_to_page = [];
 	book_to_title = [];
 	prints = [];
 	page_display_counter = 0;
 	page_length = 0;
 	results = [];
 	$("#books").empty();
 }

 function group_by_book(pages){
 	page_length = pages.length;
 	for (var p =0 ; p< pages.length; p++){
 		//TO-DO put in views.py
 		$.getScript("https://repository.library.brown.edu/api/items/"+pages[p]+"/?q=&callback=get_page_book");
 	}
 }

 function get_page_book(page_data){
 	var bookpid = null;
 	var booktitle = null;
 	var pagepid = page_data.pid;
 	var print = false;
 	if (page_data.relations.isPartOf[0]){
 		bookpid = page_data.relations.isPartOf[0]['pid'];
 		booktitle = page_data.relations.isPartOf[0]['primary_title'];
 	}
 	else if (page_data.relations.isMemberOf[0]){
 		bookpid = page_data.relations.isMemberOf[0]['pid'];
 		if (page_data.primary_title){
 			booktitle = primary_title;
 		}
 	}
 	else {
 		console.log("no collection information found");
 		if (page_data.genre == "engravings (prints)" || page_data.genre == "etchings (prints)" ){
 			console.log(pagepid+ " is a print");
 			prints.push(pagepid);
 		}
 		print = true;
 	}	
 	if (bookpid && !print){

 		if (!book_to_page[bookpid]){
 			var page_list = [];
 			page_list.push(pagepid);
 			book_to_page[bookpid] = page_list;
 		} else {
 			book_to_page[bookpid].push(pagepid);
 		}

 		if (!book_to_title[bookpid]){
 			book_to_title[bookpid] = booktitle;
 		}

 	}
 	if (!print){
 		//page_display_counter++;
 		display_page(bookpid,pagepid);
 		//display_loaded_pages();
 	} else {
 		display_print(pagepid);
 	}
 }


 </script>
{% endblock %}

{% block content %}
	<input type="text" id="search" onkeyup="inputKeyUp(event)"></input>
	<button id="searchbutton">Search</button>
	<li> Number Results: <span id= "num_results"></span></li>
	<div id = "books"></div>
	<div id = "prints"></div>
{% endblock %}
