name: CI tests

on:
  push:
    branches: [ main ]

  pull_request:
    branches: [ main ]

  # enables manual runs from any branch without a PR; minimal notifications.
  workflow_dispatch:
    inputs:
      run_merge_sim:
        description: 'Simulate PR by merging main before tests?'
        type: boolean
        default: true

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: continuous_integration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # full history so we can merge main when simulating PRs
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.8.0"
          enable-cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          # Use python-version declared in pyproject.toml
          python-version-file: "pyproject.toml"

      - name: Configure git identity (for merge)
        if: ${{ github.event_name != 'pull_request' && (github.event.inputs.run_merge_sim != 'false') }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Simulate PR merge with main (non-PR runs)
        if: ${{ github.event_name != 'pull_request' && (github.event.inputs.run_merge_sim != 'false') }}
        run: |
          git fetch origin main
          git merge --no-ff --no-edit origin/main

      - name: Install dependencies
        run: uv sync --locked

      - name: Run tests
        run: uv run ./run_tests.py

# =============================================================================
# CI WORKFLOW DOCUMENTATION
# -----------------------------------------------------------------------------
# name: ci-tests-uv
#   - The display name of this workflow in the GitHub Actions UI.
#
# on:
#   push: [ main ]
#     - Run the workflow on any push to the main branch.
#   pull_request: [ main ]
#     - Run the workflow for PRs targeting main. GitHub automatically creates
#       a temporary merge commit for PR runs, so we do NOT perform our manual
#       merge simulation in this case.
#   workflow_dispatch:
#     - Allows manual runs from any branch. Includes an input, run_merge_sim,
#       to control whether we simulate merging main before tests (default: true).
#
# concurrency:
#   group: ci-${{ github.workflow }}-${{ github.ref }}
#     - Defines the concurrency "group key". Any runs that share this exact 
#       key are considered mutually exclusive.
#   cancel-in-progress: true
#     - Ensures only one run per workflow/ref combination; newer runs cancel
#       any previous in-progress run to save CI resources.
#
# jobs.build:
#   name: continuous_integration
#   runs-on: ubuntu-latest
#     - Single job that performs checkout, environment setup, dependency
#       installation, and test execution on Ubuntu.
#
# steps:
#   - Checkout code
#     - "v4" is the version of the GitHub checkout action.
#     - "fetch-depth: 0" ensures we get the full git history, which is needed
#       for simulating PR merges.
#
#   - Install uv
#     - "v6" is the version of the GitHub setup-uv action.
#     - Installs uv (version 0.8.0) and enables caching to speed up installs.
#
#   - Setup Python
#     - Selects the Python version declared in pyproject.toml via
#       python-version-file, ensuring local and CI Python versions match.
#
#   - Configure git identity (for merge)
#     - Ensures step only runs on non-PR runs and when run_merge_sim is not 
#       'false'. Sets a bot identity required by git for creating merge 
#       commits.
#
#   - Simulate PR merge with main (non-PR runs)
#     - When manually triggered (or other non-PR events), fetches and merges
#       origin/main into the current branch to test the code as it would look
#       after merging. Helps catch integration issues early.
#
#   - Install dependencies
#       Uses 'uv sync --locked' to create a reproducible environment strictly
#       from the lockfile.
#
#   - Run tests
#       Runs the Django test suite via './run_tests.py' using uv:
#       'uv run ./run_tests.py'. This repository's run_tests.py sets
#       DJANGO_SETTINGS_MODULE=config.settings.unit_tests.
# =============================================================================
